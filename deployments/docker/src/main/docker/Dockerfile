#
# Copyright (C) 2013 Red Hat, Inc. (jdcasey@commonjava.org)
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#         http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

FROM centos

MAINTAINER John Casey <jdcasey@commonjava.org>

VOLUME /var/lib/cartographer/work /var/lib/cartographer/cache /var/lib/cartographer/data /tmp/cartographer /tmp/ssh-config

USER root

EXPOSE 8082 8000

ENV GIT_SSL_NO_VERIFY true

# TODO: I don't think we can consolidate any of these, since the target is necessary for dumb-init 
ADD https://github.com/Yelp/dumb-init/releases/download/v1.1.1/dumb-init_1.1.1_amd64 /usr/local/bin/dumb-init
ADD maven/scripts/start-cartographer.py /usr/local/bin/start-cartographer.py

# TODO: root needed to run yum...?
#USER root

RUN chmod +x /usr/local/bin/* && \
	yum -y update && \
	yum -y install wget git tar which curl tree java-1.8.0-openjdk-devel && \
	yum clean all

CMD ["/usr/local/bin/dumb-init", "/usr/local/bin/start-cartographer.py"]

# Unpack the distro that was created elsewhere in this Cartographer build.

# For some reason, ADDing the tarball directly so it's unpacked using Docker
# doesn't work correctly. It results in some sort of classpath issue, so
# let's emulate what any user might do when installing the tarball.
COPY maven/tmp/cartographer.tar.gz /tmp/cartographer.tar.gz
RUN tar -zxvf /tmp/cartographer.tar.gz -C /opt

